<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script src="/js/analytics.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Forum - Jerusalem Hills</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Join the Jerusalem Hills community forum. Discuss culture, heritage, marketplace tips, local events, and connect with fellow community members.">
    <meta name="keywords" content="Jerusalem Hills forum, community discussion, Jerusalem community, marketplace forum, local events">

    <!-- Favicon -->
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/img/logo.jpg" type="image/jpeg">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/styles-new.css">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Theme -->
    <meta name="theme-color" content="#87CEEB">

    <!-- GunDB for real-time forum -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <style>
        /* Jerusalem Hills Color Theme */
        :root {
            --primary-color: #87CEEB;
            --primary-hover: #6BB6D6;
            --secondary-color: #F0E68C;
            --accent-color: #E6D76E;
            --text-accent: #2C3E50;
            --text-dark: rgb(17, 24, 39);
            --text-medium: rgb(75, 85, 99);
            --text-light: rgb(156, 163, 175);
            --bg-white: white;
            --bg-gray: rgb(243, 244, 246);
            --border-color: rgb(229, 231, 235);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: white;
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 40px 20px;
            text-align: center;
            border-bottom: 3px solid var(--text-accent);
        }

        .header h1 {
            color: var(--text-accent);
            font-size: 36px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .header p {
            color: var(--text-accent);
            font-size: 18px;
            font-weight: 500;
        }

        .logo-link {
            display: inline-block;
            margin-bottom: 20px;
        }

        .logo {
            height: 80px;
            width: auto;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Forum Categories */
        .categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .category {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 24px;
            border-radius: 12px;
            border: 2px solid var(--text-accent);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .category:hover {
            transform: translateY(-2px);
        }

        .category h3 {
            color: var(--text-accent);
            margin-bottom: 8px;
            font-size: 20px;
        }

        .category p {
            color: var(--text-accent);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .category-stats {
            color: var(--text-accent);
            font-size: 13px;
            font-weight: 600;
        }

        /* Post Form */
        .post-form {
            background: var(--bg-gray);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 40px;
        }

        .post-form h3 {
            color: var(--text-accent);
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            color: var(--text-dark);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: var(--primary-color);
            color: var(--text-accent);
            padding: 12px 24px;
            border: 2px solid var(--text-accent);
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* Posts */
        .posts {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .post {
            background: white;
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .post-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-accent);
            font-size: 18px;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: 700;
            color: var(--text-dark);
        }

        .post-time {
            font-size: 13px;
            color: var(--text-medium);
        }

        .post-category {
            background: var(--secondary-color);
            color: var(--text-accent);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .post-content {
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .post-actions {
            display: flex;
            gap: 16px;
            font-size: 14px;
        }

        .post-action {
            color: var(--text-medium);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .post-action:hover {
            color: var(--primary-color);
        }

        /* Back Link */
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--text-accent);
            text-decoration: none;
            font-weight: 600;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-medium);
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 28px;
            }

            .categories {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 20px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Shared Header Component -->
    <div id="header-placeholder"></div>
    <script src="/js/load-header.js"></script>

    <!-- Header -->
    <div class="header">
        <a href="/" class="logo-link">
            <img src="/img/logo.jpg" alt="Jerusalem Hills Logo" class="logo">
        </a>
        <h1>Community Forum</h1>
        <p>Connect, discuss, and share with the Jerusalem Hills community</p>
        
        <!-- Age Restriction & Terms Notice -->
        <div style="background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 10px; margin-top: 20px; max-width: 700px; margin-left: auto; margin-right: auto; border: 2px solid var(--text-accent);">
            <h3 style="color: var(--text-accent); margin-bottom: 10px; font-size: 16px;">üîû Adults Only Forum (18+)</h3>
            <p style="color: var(--text-accent); font-size: 14px; margin: 10px 0; line-height: 1.5;">
                <strong>Age Restriction:</strong> You must be 18+ to use this forum. By participating, you confirm you are an adult.
                <br><strong>Zero Data Collection:</strong> We don't store cookies, track users, or collect personal information. 
                Your posts flow through the decentralized GunDB network - nothing stored on our servers.
                <br><strong>Terms:</strong> <a href="/forum/terms.html" style="color: var(--text-accent); text-decoration: underline;">Read our Terms of Service</a> which include comprehensive legal protections and user responsibilities.
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Home</a>

        <!-- Forum Categories -->
        <div class="categories">
            <div class="category" onclick="filterCategory('culture')">
                <h3>üèõÔ∏è Culture & Heritage</h3>
                <p>Discuss Jerusalem's rich cultural heritage and traditions</p>
                <div class="category-stats">24 discussions ‚Ä¢ 156 messages</div>
            </div>

            <div class="category" onclick="filterCategory('marketplace')">
                <h3>üõçÔ∏è Marketplace</h3>
                <p>Tips, reviews, and discussions about marketplace products</p>
                <div class="category-stats">18 discussions ‚Ä¢ 92 messages</div>
            </div>

            <div class="category" onclick="filterCategory('events')">
                <h3>üìÖ Local Events</h3>
                <p>Share and discover local events and gatherings</p>
                <div class="category-stats">12 discussions ‚Ä¢ 78 messages</div>
            </div>

            <div class="category" onclick="filterCategory('suggestions')">
                <h3>üí° Website Feedback & Suggestions</h3>
                <p>Share ideas, report bugs, and suggest improvements for the website</p>
                <div class="category-stats">8 discussions ‚Ä¢ 32 messages</div>
            </div>

            <div class="category" onclick="filterCategory('general')">
                <h3>üí¨ General Discussion</h3>
                <p>Off-topic conversations and community chat</p>
                <div class="category-stats">45 discussions ‚Ä¢ 234 messages</div>
            </div>
        </div>

        <!-- Post Form -->
        <div class="post-form">
            <h3>Start a New Discussion</h3>
            
            <!-- Community Guidelines Notice -->
            <div style="background: #f0f8ff; border: 1px solid #ddeeff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: var(--text-accent); margin-bottom: 8px; font-size: 14px;">üìù Community Guidelines</h4>
                <p style="color: var(--text-medium); font-size: 13px; margin: 0; line-height: 1.4;">
                    <strong>Family-friendly forum:</strong> Only vulgar language/cuss words are automatically replaced with asterisks (****). 
                    Normal dictionary words are perfectly fine - discuss history, politics, current events freely!
                    <br><strong>Images not allowed</strong> at this time. <strong>Privacy:</strong> This is a completely anonymous forum.
                </p>
            </div>
            
            <form id="postForm">
                <div class="form-group">
                    <label for="username">Your Name</label>
                    <input type="text" id="username" placeholder="Enter your name" required>
                </div>

                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" required>
                        <option value="">Select a category</option>
                        <option value="culture">Culture & Heritage</option>
                        <option value="marketplace">Marketplace</option>
                        <option value="events">Local Events</option>
                        <option value="suggestions">Website Feedback & Suggestions</option>
                        <option value="general">General Discussion</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" placeholder="What's your discussion about?" required>
                </div>

                <div class="form-group">
                    <label for="message">Message</label>
                    <textarea id="message" placeholder="Share your thoughts..." required></textarea>
                </div>

                <button type="submit" class="btn">Post Discussion</button>
            </form>
        </div>

        <!-- Posts Section -->
        <h2 style="margin-bottom: 20px; color: var(--text-accent);">Recent Discussions</h2>
        <div id="posts" class="posts">
            <div class="loading">Loading discussions...</div>
        </div>
    </div>

    <script>
        // Initialize GunDB with multiple relay servers for better sync
        const gun = Gun([
            'https://gun-manhattan.herokuapp.com/gun',
            'https://gunjs.herokuapp.com/gun',
            'https://e2eec.herokuapp.com/gun'
        ]);
        const forum = gun.get('jerusalemhills-forum-v2');

        let currentFilter = 'all';
        let allPosts = [];

        // Anonymous session - no data stored persistently
        // Generate temporary session identifier for this browser session only
        const sessionId = 'anon-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
        console.log('Anonymous session started:', sessionId);

        // Content moderation - client-side filtering for basic abuse prevention
        const contentFilter = {
            // Profanity replacement list - ONLY actual cuss words/vulgar language
            profanityWords: [
                // English profanity/cuss words
                'fuck', 'fucking', 'fucked', 'fucker', 'fucks',
                'shit', 'shitting', 'shitty', 'bullshit',
                'bitch', 'bitching', 'bitches',
                'ass', 'asshole', 'asses', 
                'damn', 'damned', 'dammit',
                'motherfucker', 'motherfucking',
                'dickhead', 'prick', 'cock', 'dick',
                'whore', 'slut', 'sluts', 'whores',
                'bastard', 'bastards',
                'cunt', 'cunts',
                'tits', 'boobs', 'pussy',
                
                // Russian profanity/cuss words
                '–±–ª—è—Ç', '–±–ª—è–¥—å', '–±–ª—è–¥–∏', '–±–ª—è—Ö–∞',
                '—Ö—É–π', '—Ö—É—è', '—Ö—É–µ', '—Ö—É—é',
                '–ø–∏–∑–¥–∞', '–ø–∏–∑–¥–µ', '–ø–∏–∑–¥—É', '–ø–∏–∑–¥–µ—Ü',
                '—Å—É–∫–∞', '—Å—É–∫–∏', '—Å—É—á–∫–∞',
                '–≥–∞–≤–Ω–æ', '–≥–æ–≤–Ω–æ', '–¥–µ—Ä—å–º–æ',
                '–µ–±–∞—Ç—å', '–µ–±–∞–ª', '–µ–±–µ—Ç', '–µ–±—É—Ç',
                'blat', 'blyat', 'blyad', 'blyadi',
                'hui', 'huya', 'huy', 'khuy',
                'pisda', 'pizda', 'pizdets',
                'suka', 'suki', 'suchka',
                'gavno', 'govno', 'derimo',
                'ebat', 'ebal', 'ebet',
                
                // Hebrew profanity/cuss words
                '◊ñ◊ô◊ô◊ü', '◊ñ◊ô◊ü', '◊ñ◊ô◊†◊î',
                '◊õ◊ï◊°', '◊õ◊ï◊°◊ô◊™',
                '◊ó◊®◊ê', '◊ó◊®◊ï◊™',
                '◊û◊†◊ô◊ê◊ß', '◊û◊†◊ô◊ê◊ß◊ô◊ù',
                '◊ë◊ü ◊ñ◊ï◊†◊î', '◊ñ◊ï◊†◊î',
                
                // Other languages - only actual cuss words
                'merde', 'putain', 'salope',  // French
                'scheisse', 'schei√üe', 'fotze',  // German
                'puta', 'puto', 'joder',  // Spanish
                'cazzo', 'merda', 'stronzo',  // Italian
                'kurwa', 'kurwy',  // Polish
                'porra', 'caralho'  // Portuguese
            ],
            
            // Only block truly problematic content (spam/technical threats)
            seriousInappropriateWords: [
                // Spam/scam related
                'spam', 'scam', 'fake website', 'virus download', 'malware',
                // Hate speech/discrimination
                'nazi', 'hitler', 'kill all', 'death to',
                // Extreme harassment  
                'kys', 'kill yourself', 'commit suicide',
                // Doxxing/personal info
                'home address', 'phone number', 'ssn', 'social security',
                'phishing', 'click here to hack', 'free money',
                // Only block if promoting illegal activity, not discussing
                'how to hack', 'buy drugs', 'sell drugs', 'free hacking tools'
            ],
            
            // Spam patterns
            spamPatterns: [
                /(.)\1{10,}/g,  // Repeated characters (more than 10)
                /[A-Z]{20,}/g,   // All caps (more than 20 chars)
                /https?:\/\/[^\s]+\.tk|\.ml|\.ga/g,  // Suspicious domains
                /\b\d{10,}\b/g,  // Long number sequences (phone numbers, etc.)
                /[^\w\s]{5,}/g   // Multiple special characters in sequence
            ],

            // Replace profanity with asterisks
            replaceProfanity: function(text) {
                if (!text || typeof text !== 'string') return text;
                
                let cleanText = text;
                
                // Replace profanity words with asterisks
                this.profanityWords.forEach(word => {
                    const regex = new RegExp('\\b' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'gi');
                    cleanText = cleanText.replace(regex, '*'.repeat(word.length));
                });
                
                return cleanText;
            },

            // Check for inappropriate content
            checkContent: function(text) {
                if (!text || typeof text !== 'string') return { allowed: false, reason: 'Invalid content', cleanText: text };
                
                const lowerText = text.toLowerCase();
                
                // Block image posting attempts (no image screening capability)
                const imagePatterns = [
                    /\.(jpg|jpeg|png|gif|bmp|webp|svg|ico)/gi,  // Image file extensions
                    /data:image\//gi,  // Base64 images
                    /<img/gi,  // HTML img tags
                    /\[img\]/gi,  // BBCode images
                    /!\[.*\]\(.*\)/gi  // Markdown images
                ];
                
                for (let pattern of imagePatterns) {
                    if (pattern.test(text)) {
                        return { allowed: false, reason: 'Images not allowed at this time', cleanText: text };
                    }
                }
                
                // Check for seriously inappropriate words (these block the post)
                for (let word of this.seriousInappropriateWords) {
                    if (lowerText.includes(word)) {
                        return { allowed: false, reason: 'Contains inappropriate content', cleanText: text };
                    }
                }
                
                // Replace profanity with asterisks (don't block, just clean)
                const cleanText = this.replaceProfanity(text);
                
                // Check for spam patterns on cleaned text
                for (let pattern of this.spamPatterns) {
                    if (pattern.test(cleanText)) {
                        return { allowed: false, reason: 'Contains spam-like content', cleanText: cleanText };
                    }
                }
                
                // Check length limits
                if (cleanText.length > 2000) {
                    return { allowed: false, reason: 'Message too long (max 2000 characters)', cleanText: cleanText };
                }
                
                if (cleanText.trim().length < 3) {
                    return { allowed: false, reason: 'Message too short', cleanText: cleanText };
                }
                
                return { allowed: true, cleanText: cleanText };
            },

            // Rate limiting per session
            postTimes: [],
            checkRateLimit: function() {
                const now = Date.now();
                const fiveMinutesAgo = now - (5 * 60 * 1000);
                
                // Clean old timestamps
                this.postTimes = this.postTimes.filter(time => time > fiveMinutesAgo);
                
                // Check if too many posts in 5 minutes
                if (this.postTimes.length >= 5) {
                    return { allowed: false, reason: 'Too many posts. Please wait a few minutes.' };
                }
                
                this.postTimes.push(now);
                return { allowed: true };
            },

            // Validate links
            validateLinks: function(text) {
                const urlRegex = /https?:\/\/[^\s]+/g;
                const urls = text.match(urlRegex) || [];
                
                const bannedDomains = [
                    '.tk', '.ml', '.ga', '.cf',  // Free suspicious domains
                    'bit.ly', 'tinyurl.com',     // URL shorteners
                    'telegram.me', 'discord.gg'  // Messaging platforms
                ];
                
                for (let url of urls) {
                    for (let domain of bannedDomains) {
                        if (url.includes(domain)) {
                            return { allowed: false, reason: 'Suspicious links not allowed' };
                        }
                    }
                }
                
                // Limit number of links
                if (urls.length > 2) {
                    return { allowed: false, reason: 'Too many links (max 2 per post)' };
                }
                
                return { allowed: true };
            },

            // Check for repeated characters (spam detection)
            checkSpamPatterns: function(text) {
                // Check for excessive repeated characters
                if (/(.)\1{10,}/.test(text)) {
                    return { allowed: false, reason: 'Excessive repeated characters detected' };
                }
                
                // Check for excessive caps
                const capsRatio = (text.match(/[A-Z]/g) || []).length / text.length;
                if (text.length > 20 && capsRatio > 0.7) {
                    return { allowed: false, reason: 'Excessive use of capital letters' };
                }
                
                // Check for excessive punctuation
                const punctRatio = (text.match(/[!?.,;:]/g) || []).length / text.length;
                if (text.length > 20 && punctRatio > 0.4) {
                    return { allowed: false, reason: 'Excessive punctuation detected' };
                }
                
                return { allowed: true };
            },

            // Enhanced content validation
            validatePost: function(title, message, username) {
                // Check all content pieces
                const titleCheck = this.checkContent(title);
                if (!titleCheck.allowed) return { allowed: false, reason: 'Title: ' + titleCheck.reason };
                
                const messageCheck = this.checkContent(message);
                if (!messageCheck.allowed) return { allowed: false, reason: 'Message: ' + messageCheck.reason };
                
                const usernameCheck = this.checkContent(username);
                if (!usernameCheck.allowed) return { allowed: false, reason: 'Username: ' + usernameCheck.reason };
                
                // Check spam patterns
                const titleSpam = this.checkSpamPatterns(title);
                if (!titleSpam.allowed) return titleSpam;
                
                const messageSpam = this.checkSpamPatterns(message);
                if (!messageSpam.allowed) return messageSpam;
                
                // Check links in message
                const linkCheck = this.validateLinks(message);
                if (!linkCheck.allowed) return linkCheck;
                
                return { 
                    allowed: true, 
                    cleanTitle: titleCheck.cleanText,
                    cleanMessage: messageCheck.cleanText,
                    cleanUsername: usernameCheck.cleanText
                };
            }
        };

        // Post Form Handler
        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const category = document.getElementById('category').value;
            const title = document.getElementById('title').value.trim();
            const message = document.getElementById('message').value.trim();

            if (!username || !category || !title || !message) {
                alert('Please fill in all fields');
                return;
            }

            // Content moderation checks
            const rateCheck = contentFilter.checkRateLimit();
            if (!rateCheck.allowed) {
                alert(rateCheck.reason);
                return;
            }

            // Enhanced validation using new method
            const validation = contentFilter.validatePost(title, message, username);
            if (!validation.allowed) {
                alert(validation.reason);
                return;
            }

            // Use cleaned content from validation (profanity replaced, spam checked)
            const cleanTitle = validation.cleanTitle;
            const cleanMessage = validation.cleanMessage;
            const cleanUsername = validation.cleanUsername;

            // Link validation is now included in validatePost method

            // No data persistence - anonymous posting only

            // Create post object with cleaned content
            const post = {
                username: username,
                category: category,
                title: cleanTitle,
                message: cleanMessage,
                timestamp: Date.now(),
                id: 'post-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
            };

            // Show user if content was cleaned
            if (cleanTitle !== title || cleanMessage !== message) {
                const changesMessage = 'Note: Some words were automatically replaced with asterisks (****) to keep the forum family-friendly.';
                alert(changesMessage);
            }

            // Save to GunDB with confirmation
            forum.get('posts').get(post.id).put(post, function(ack) {
                if (ack.err) {
                    console.error('Error posting:', ack.err);
                    alert('Error posting discussion. Please try again.');
                } else {
                    console.log('Post saved successfully:', post.id);

                    // Clear form
                    document.getElementById('title').value = '';
                    document.getElementById('message').value = '';
                    document.getElementById('category').value = '';

                    alert('Discussion posted successfully! It will sync to other devices.');
                }
            });
        });

        // Load posts from GunDB
        function loadPosts() {
            const postsContainer = document.getElementById('posts');
            allPosts = [];

            forum.get('posts').map().on(function(post, id) {
                if (post && post.username && post.id) {
                    // Check if post already exists in array
                    const existingIndex = allPosts.findIndex(p => p.id === post.id);

                    if (existingIndex >= 0) {
                        // Update existing post
                        allPosts[existingIndex] = post;
                    } else {
                        // Add new post
                        allPosts.push(post);
                        console.log('New post received:', post.title);
                    }

                    // Re-render when data changes
                    renderPosts();
                }
            });

            // Also listen for new posts explicitly
            forum.get('posts').on(function(data, key) {
                console.log('Forum data updated:', key);
            });
        }

        // Render posts
        function renderPosts() {
            const postsContainer = document.getElementById('posts');

            // Filter posts
            let filteredPosts = currentFilter === 'all'
                ? allPosts
                : allPosts.filter(p => p.category === currentFilter);

            // Sort by timestamp (newest first)
            filteredPosts.sort((a, b) => b.timestamp - a.timestamp);

            if (filteredPosts.length === 0) {
                postsContainer.innerHTML = '<div class="loading">No discussions yet. Be the first to post!</div>';
                return;
            }

            postsContainer.innerHTML = filteredPosts.map(post => {
                const timeAgo = getTimeAgo(post.timestamp);
                const initial = post.username.charAt(0).toUpperCase();
                const categoryName = getCategoryName(post.category);

                return `
                    <div class="post">
                        <div class="post-header">
                            <div class="post-avatar">${initial}</div>
                            <div class="post-meta">
                                <div class="post-author">${escapeHtml(post.username)}</div>
                                <div class="post-time">${timeAgo}</div>
                            </div>
                            <div class="post-category">${categoryName}</div>
                        </div>
                        <h3 style="color: var(--text-accent); margin-bottom: 8px; font-size: 18px;">${escapeHtml(post.title)}</h3>
                        <div class="post-content">${escapeHtml(post.message)}</div>
                        <div class="post-actions">
                            <span class="post-action" onclick="likePost('${post.id}')">üëç Like</span>
                            <span class="post-action">üí¨ Reply</span>
                            <span class="post-action" onclick="flagPost('${post.id}', '${escapeHtml(post.title)}')">üö© Flag</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter by category
        function filterCategory(category) {
            currentFilter = category;
            renderPosts();
            window.scrollTo({ top: document.querySelector('.post-form').offsetTop - 20, behavior: 'smooth' });
        }

        // Helper: Get time ago
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';

            return new Date(timestamp).toLocaleDateString();
        }

        // Helper: Get category name
        function getCategoryName(category) {
            const names = {
                'culture': 'üèõÔ∏è Culture & Heritage',
                'marketplace': 'üõçÔ∏è Marketplace',
                'events': 'üìÖ Local Events',
                'suggestions': 'üí° Website Suggestions',
                'general': 'üí¨ General'
            };
            return names[category] || category;
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Community moderation functions
        function likePost(postId) {
            // Simple like functionality (session-based)
            console.log('Liked post:', postId);
            alert('üëç Thanks for your feedback!');
        }

        function flagPost(postId, title) {
            const reason = prompt(
                `Flag "${title}" for inappropriate content?\n\n` +
                'Please briefly explain why this post should be reviewed:\n' +
                '(This helps the community maintain quality discussions)'
            );
            
            if (reason && reason.trim()) {
                // Store flag in GunDB for community awareness
                const flag = {
                    postId: postId,
                    reason: reason.trim(),
                    timestamp: Date.now(),
                    sessionId: sessionId  // Anonymous session identifier
                };
                
                forum.get('flags').get('flag-' + Date.now()).put(flag, function(ack) {
                    if (ack.err) {
                        alert('Error submitting flag. Please try again.');
                    } else {
                        alert('Thank you for helping maintain community standards. The post has been flagged for review.');
                    }
                });
            }
        }

        // Initialize
        console.log('Initializing forum...');
        loadPosts();

        // Connection status monitoring
        let syncCheckInterval = setInterval(() => {
            const peers = gun._.opt.peers;
            const connectedPeers = Object.keys(peers).filter(url => peers[url].wire).length;
            console.log('Connected to', connectedPeers, 'GunDB peers');
        }, 10000);

        // Add some sample posts if none exist (for demo)
        setTimeout(() => {
            if (allPosts.length === 0) {
                console.log('No posts found, adding sample data...');
                const samplePosts = [
                    {
                        id: 'sample-1',
                        username: 'Sarah Cohen',
                        category: 'culture',
                        title: 'Jerusalem Culture & Heritage Discussion',
                        message: 'What are your favorite cultural sites in Jerusalem? I recently visited the Old City and was amazed by the history.',
                        timestamp: Date.now() - 3600000
                    },
                    {
                        id: 'sample-2',
                        username: 'David Levi',
                        category: 'marketplace',
                        title: 'Best Olive Oil Products',
                        message: 'Just received my olive oil from the marketplace. The quality is outstanding! Highly recommend.',
                        timestamp: Date.now() - 7200000
                    },
                    {
                        id: 'sample-3',
                        username: 'Rachel Stone',
                        category: 'events',
                        title: 'Local Events This Weekend',
                        message: 'Anyone know of any interesting events happening this weekend in Jerusalem?',
                        timestamp: Date.now() - 10800000
                    },
                    {
                        id: 'sample-4',
                        username: 'Forum Admin',
                        category: 'suggestions',
                        title: 'Welcome to Website Feedback!',
                        message: 'This section is for sharing ideas about improving the Jerusalem Hills website. Found a bug? Have a feature suggestion? Let us know here! We read every suggestion.',
                        timestamp: Date.now() - 14400000
                    },
                    {
                        id: 'sample-5',
                        username: 'Alex Tech',
                        category: 'suggestions',
                        title: 'Mobile Experience Feedback',
                        message: 'The historical map works great on mobile! The touch controls are very responsive. Maybe add a back button to make navigation easier?',
                        timestamp: Date.now() - 18000000
                    }
                ];

                samplePosts.forEach(post => {
                    forum.get('posts').get(post.id).put(post, function(ack) {
                        console.log('Sample post added:', post.id, ack.err ? 'ERROR' : 'OK');
                    });
                });
            }
        }, 3000);
    </script>
</body>
</html>
